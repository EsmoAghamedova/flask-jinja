{% extends 'base.html' %}
{% block title %}CalmSpace - Dashboard{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='style/tracker.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style/dashboard.css') }}" />
{% endblock %}

{% block navbar %}
  <aside class="dashboard-sidebar">
    <div class="sidebar-brand">
      <a href="{{ url_for('user.dashboard') }}" class="brand-link">CalmSpace</a>
      <span class="badge bg-success-subtle text-success">User</span>
    </div>
    <nav class="sidebar-nav">
      <a class="sidebar-link active" href="{{ url_for('user.dashboard') }}">üè† Dashboard</a>
      <a class="sidebar-link" href="{{ url_for('user.mood') }}">üß† Mood Tracker</a>
      <a class="sidebar-link" href="{{ url_for('user.todo') }}">‚úÖ To-Do</a>
      <a class="sidebar-link" href="{{ url_for('user.habit') }}">üî• Habits</a>
      <a class="sidebar-link" href="{{ url_for('user.badges') }}">üèÖ Badges</a>
      <a class="sidebar-link" href="{{ url_for('user.progress') }}">üìà Progress</a>
      <a class="sidebar-link" href="{{ url_for('settings.index') }}">‚öôÔ∏è Settings</a>
    </nav>
    <div class="sidebar-footer">
      <span class="text-muted small">Signed in as</span>
      <strong>{{ user.username }}</strong>
      <a class="btn btn-outline-secondary btn-sm mt-2" href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
  </aside>
{% endblock %}

{% block content %}
  <div class="dashboard-layout">
    <div class="dashboard-main">
      <section class="container dashboard">
        {% with messages=get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-3">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} mb-2" role="alert">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
          <div>
            <h2 class="mb-2">Welcome back, {{ user.username }} üëã</h2>
            <p class="text-muted mb-0">Your mood tracker, habits, to-dos, and badges‚Äîtogether in one space.</p>
          </div>
          <div class="d-flex gap-2">
            <a href="{{ url_for('user.progress') }}" class="btn start-btn">View Progress</a>
            <a href="{{ url_for('user.badges') }}" class="btn btn-outline-secondary">All Badges</a>
          </div>
        </div>

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card glass-card p-4 dashboard-card h-100">
          <h4>üß† Moods</h4>
          <p class="lead mb-1">{{ summary.moods }}</p>
          <p class="text-muted mb-0 small">entries logged</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card glass-card p-4 dashboard-card h-100">
          <h4>‚úÖ To-Do</h4>
          <p class="lead mb-1">{{ summary.todos_done }} / {{ summary.todos }}</p>
          <p class="text-muted mb-0 small">tasks completed</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card glass-card p-4 dashboard-card h-100">
          <h4>üî• Habits</h4>
          <p class="lead mb-1">{{ summary.habits }}</p>
          <p class="text-muted mb-0 small">active habits</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card glass-card p-4 dashboard-card h-100">
          <h4>üèÖ Badges</h4>
          <p class="lead mb-1">{{ badges|length }}</p>
          <p class="text-muted mb-0 small">earned</p>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card glass-card p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">üß† Mood Tracker</h4>
            <a href="{{ url_for('user.mood') }}" class="link-muted">View all</a>
          </div>
          <form action="{{ url_for('user.mood') }}" method="post" class="mb-3">
            {{ mood_form.hidden_tag() }}
            <div class="row g-2">
              <div class="col-md-4">
                {{ mood_form.mood.label(class="form-label") }}
                {{ mood_form.mood(class="form-select") }}
              </div>
              <div class="col-md-8">
                {{ mood_form.notes.label(class="form-label") }}
                {{ mood_form.notes(class="form-control", rows="2", placeholder="How are you feeling?") }}
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-primary">Log mood</button>
            </div>
          </form>
          <div>
            <h6 class="text-muted">Recent moods</h6>
            {% if recent_moods %}
              <ul class="list-group list-group-flush">
                {% for mood in recent_moods %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ mood.mood }}</strong>
                      {% if mood.notes %}
                        <p class="mb-0 text-muted small">{{ mood.notes }}</p>
                      {% endif %}
                    </div>
                    <span class="badge bg-light text-dark">{{ mood.created_at.strftime('%b %d') }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">No moods logged yet. Start with a quick check-in!</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card glass-card p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">‚úÖ To-Do</h4>
            <a href="{{ url_for('user.todo') }}" class="link-muted">View all</a>
          </div>
          <form action="{{ url_for('user.todo') }}" method="post" class="mb-3">
            {{ todo_form.hidden_tag() }}
            <div class="mb-2">
              {{ todo_form.task.label(class="form-label") }}
              {{ todo_form.task(class="form-control", placeholder="Top priority task") }}
            </div>
            <div class="mb-2">
              {{ todo_form.detail.label(class="form-label") }}
              {{ todo_form.detail(class="form-control", rows="2", placeholder="Optional details") }}
            </div>
            <div class="form-check mb-3">
              {{ todo_form.done(class="form-check-input") }}
              {{ todo_form.done.label(class="form-check-label") }}
            </div>
            <button type="submit" class="btn btn-primary">Add task</button>
          </form>

          <div class="todo-lists">
            <h6 class="text-muted">Active tasks</h6>
            {% if active_todos %}
              <ul class="list-group list-group-flush mb-3">
                {% for todo in active_todos %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ todo.task }}</strong>
                      {% if todo.detail %}
                        <p class="mb-0 text-muted small">{{ todo.detail }}</p>
                      {% endif %}
                    </div>
                    <form action="{{ url_for('user.todo_toggle', todo_id=todo.id) }}" method="post">
                      {{ action_form.hidden_tag() }}
                      <button type="submit" class="btn btn-sm btn-outline-success">Done</button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No active tasks. You're all caught up!</p>
            {% endif %}

            <h6 class="text-muted">Recently completed</h6>
            {% if completed_todos %}
              <ul class="list-group list-group-flush">
                {% for todo in completed_todos %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="text-decoration-line-through">{{ todo.task }}</span>
                    <form action="{{ url_for('user.todo_toggle', todo_id=todo.id) }}" method="post">
                      {{ action_form.hidden_tag() }}
                      <button type="submit" class="btn btn-sm btn-outline-secondary">Undo</button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">Complete a task to see it here.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card glass-card p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">üî• Habits</h4>
            <a href="{{ url_for('user.habit') }}" class="link-muted">View all</a>
          </div>
          <form action="{{ url_for('user.habit') }}" method="post" class="mb-3">
            {{ habit_form.hidden_tag() }}
            <div class="row g-2">
              <div class="col-md-7">
                {{ habit_form.habit.label(class="form-label") }}
                {{ habit_form.habit(class="form-control", placeholder="New habit") }}
              </div>
              <div class="col-md-5">
                {{ habit_form.frequency.label(class="form-label") }}
                {{ habit_form.frequency(class="form-select") }}
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Add habit</button>
          </form>

          <div class="habit-list">
            {% if habits %}
              <ul class="list-group list-group-flush">
                {% for habit in habits %}
                  <li class="list-group-item d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                      <strong>{{ habit.habit }}</strong>
                      <p class="mb-0 text-muted small">Frequency: {{ habit.frequency or 'Custom' }}</p>
                    </div>
                    <form action="{{ url_for('user.habit_complete', habit_id=habit.id) }}" method="post">
                      {{ action_form.hidden_tag() }}
                      {% if habit.id in completed_today %}
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Undo today</button>
                      {% else %}
                        <button type="submit" class="btn btn-sm btn-outline-success">Mark done</button>
                      {% endif %}
                    </form>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">Add a habit to start building your streak.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card glass-card p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">üèÖ Badges</h4>
            <a href="{{ url_for('user.badges') }}" class="link-muted">See details</a>
          </div>
          {% if badges %}
            <div class="d-flex flex-column gap-3">
              {% for badge in badges %}
                <div class="badge-card">
                  <span class="emoji">{{ badge.emoji }}</span>
                  <div>
                    <strong>{{ badge.name }}</strong>
                    <p class="mb-0 text-muted small">{{ badge.desc }}</p>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No badges yet. Log a mood or complete a task to earn your first one.</p>
          {% endif %}
        </div>
      </div>
    </div>
      </section>
    </div>
  </div>
{% endblock %}
